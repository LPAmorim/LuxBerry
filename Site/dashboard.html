<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0/dist/chartjs-plugin-annotation.min.js"></script>
</head>

<body>
  <div class="flex-dash">
    <div id="header" class="header-dash">
      <img src="../assets/Lux Berry 1.png" alt=""></a>
      <div>
        <a href="notificacoes-dash.html">Alertas</a>
        <a href="cadastro.html">Cadastre um funcionário</a>
        <a href="./suporte.html">suporte</a>
        <a href="index.html" style="color: red;">Sair</a>
      </div>
    </div>

    <div class="dashboard container">
      <p class="bem-vindo">Olá XXXXX, bem vindo de volta!</p>
      <div class="div-canvas">
        <p>Captura de Luminosidade em intervalo de 1 hora - Estufa</p>
        <select id="ipt_estufaSelect">
          <option value="#">Escolha uma estufa</option>
          <option value="1">Estufa 1</option>
          <option value="2">Estufa 2</option>
        </select>
        <select id="ipt_sensorSelect">
          <option value="#">Escolha um sensor</option>
          <option value="1">Sensor 01</option>
          <option value="2">Sensor 02</option>
        </select>
        <canvas id="grafico1" style="width: 100vh; height: 200px;"></canvas>
      </div>

      <div class="div-grafico-canvas2">
        <div class="div-grafico-canvas2-lum">
          <p>Luminosidade média</p>
          <div class="div-canvas2">
            <canvas id="grafico2" style="width: 105vh; height: 200px;"></canvas>
          </div>
        </div>

        <div class="div-kpi">
          <div class="div-kpi1">
            <div class="card-kpi">
              <p class="title-kpi">Tempo fora da faixa de segurança</p>
              <p id="tempoIdeal">--</p>
            </div>
            <div class="card-kpi">
              <p class="title-kpi">Alertas de luminosidade</p>
              <p id="alertas">--</p>
            </div>
          </div>
          <div class="div-kpi1">
            <div class="card-kpi">
              <p class="title-kpi">Picos de luminosidade<br>(maior / menor)</p>
              <p id="picos">--</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./script/maior&menor.js"></script>
  <script>
    const ctx = document.getElementById('grafico1').getContext('2d');
    const ctx2 = document.getElementById('grafico2').getContext('2d');

    // faço um array para chumbar os valores das estufas(simulando duas estufas)
    // faço um array para chumbar os valores dos sensores(simulando dentro de cada estufa)
    const dadosSensor = {
      '1': {
        linha: [1014.50, 1368.00, 1058.25, 1237.4, 900, 1100,],
        barras: [1014.5, 1368, 1058.25, 1326.5, 1372.25],
        desvios: [176.29, 138.27, 141.08, 55.01, 260.27, 105.20, 176.29],
        tempoIdeal: "01:48:59",
        alertas: 1,
        picos: '1368 / 750',
      },
      '2': {
        linha: [900, 1100, 1200, 750, 1100.2, 1050.52],
        barras: [950, 1100, 980, 1150, 1175],
        desvios: [100, 90, 85, 110, 95],
        tempoIdeal: '120:24:41',
        alertas: 0,
        picos: '1175 / 900',
      },
      '3': {
        linha: [900, 1100, 980, 1150, 1014.50, 1368.00],
        barras: [950, 1100, 980, 1150, 1175],
        desvios: [100, 90, 85, 110, 95],
        tempoIdeal: '120:24:41',
        alertas: 0,
        picos: '1175 / 900',
      },
      '4': {
        linha: [1014.50, 1368.00, 1500, 1020, 1700, 950],
        barras: [950, 1100, 1700, 1150, 1175],
        desvios: [100, 90, 85, 110, 95],
        tempoIdeal: '120:24:41',
        alertas: 2,
        picos: '1175 / 900',
      }
    };
    // faço um join nos valores
    const linhaEstufa1 = [...dadosSensor['1'].linha, ...dadosSensor['2'].linha];
    const linhaEstufa2 = [...dadosSensor['3'].linha, ...dadosSensor['4'].linha];

    // Calcula os picos ANTES de criar o objeto
    const picosEstufa1 = ${ buscarMaior(linhaEstufa1)} / ${buscarMenor(linhaEstufa1)};
    const picosEstufa2 = ${ buscarMaior(linhaEstufa2)} / ${buscarMenor(linhaEstufa2)};

    const dadosEstufas = {
      "1": {
        linha: linhaEstufa1,
        barras: [1014.5, 1368, 1058.25, 1326.5, 1372.25],
        desvios: [176.29, 138.27, 141.08, 55.01, 260.27, 105.20, 176.29],
        tempoIdeal: "01:48:59",
        alertas: 1,
        picos: picosEstufa1,
      },
      "2": {
        linha: linhaEstufa2,
        barras: [950, 1100, 980, 1150, 1175],
        desvios: [100, 90, 85, 110, 95],
        tempoIdeal: '120:24:41',
        alertas: 2,
        picos: picosEstufa2,
      }
    };

    //crio meu grafico sem dados
    const grafico1 = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['8:00:00 - 8:20:00', '8:20:00 - 8:40:00', '8:40:00 - 9:00:00', '9:00:00 - 9:20:00', '9:20:00 - 9:40:00', '9:40:00 - 10:00:00', '10:00:00 - 10:20:00', '10:20:00 - 10:40:00'],
        datasets: [{
          label: 'Lux detectado',
          data: [],
          fill: false,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          annotation: {
            annotations: {
              maxLine: {
                type: 'line',
                yMin: 1500,
                yMax: 1500,
                borderColor: 'red',
                borderWidth: 2,
                label: {
                  content: 'Lux Máximo',
                  enabled: true,
                  position: 'end'
                }
              },
              minLine: {
                type: 'line',
                yMin: 800,
                yMax: 800,
                borderColor: 'red',
                borderWidth: 2,
                label: {
                  content: 'Lux Mínimo',
                  enabled: true,
                  position: 'start'
                }
              }
            }
          }
        }
      }
    });
    //grafico sem dados
    const grafico2 = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
        datasets: [
          {
            label: 'Luminosidade média',
            data: [],
            backgroundColor: 'green',
            borderRadius: 100,
            barThickness: 30
          },
          {
            label: 'Desvio Padrão',
            data: [],
            backgroundColor: 'rgb(188, 71, 73)',
            borderRadius: 100,
            barThickness: 30
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, grid: { display: true } },
          x: { grid: { display: true } }
        }
      }
    });

    //coloca uma função para "escutar" quando houver mudança, passando o change como parametro para verificar o quando o valor do select muda
    ipt_estufaSelect.addEventListener('change', () => {
      //pego o valor do select
      const valor = ipt_estufaSelect.value;

      if (valor === "#" || !dadosEstufas[valor]) {
        grafico1.data.datasets[0].data = [];
        grafico2.data.datasets[0].data = [];
        grafico2.data.datasets[1].data = [];

        document.getElementById('tempoIdeal').innerText = '__';
        document.getElementById('alertas').innerText = '__';
        document.getElementById('picos').innerText = '__';

        grafico1.update();
        grafico2.update();
        return;
      }

      //crio uma variavel para chamar os valores que ele está setando segundo o select q esta no meu valor
      const dados = dadosEstufas[valor];

      //chamando o grafico e os dados para setar os dados da minha array
      //chamo os dados da linha para o meu grafico
      //uso o 0 por ser o primeiro dado a entrar no meu grafico1
      //data.datasets[0].data é apenas o caminho que tem dentro do grafico para setar os dados no grafico igual no grafico quando se seta na mão
      grafico1.data.datasets[0].data = dados.linha;
      //chamo os dados da barra para o meu grafico
      //uso 0 por ser o primeiro dado a entrar no meu grafico 2
      grafico2.data.datasets[0].data = dados.barras;
      //chamo os dados da desvios para o meu grafico
      //uso 1 por ser o segundo dado no meu grafico 2 de barras
      grafico2.data.datasets[1].data = dados.desvios;

      //substituo os valores das minhas kpis reescrevendo com os dados do meu sensor 1 setado no array dadosEstufas->dados
      document.getElementById('tempoIdeal').innerText = dados.tempoIdeal;
      document.getElementById('alertas').innerText = dados.alertas;
      document.getElementById('picos').innerText = dados.picos;

      //atualizo na pagina
      grafico1.update();
      grafico2.update();
    });

    //coloca uma função para "escutar" quando houver mudança, passando o change como parametro para verificar o quando o valor do select muda
    ipt_sensorSelect.addEventListener('change', () => {
      const valor = ipt_sensorSelect.value;

      if (valor === "#" || !dadosSensor[valor]) {
        grafico1.data.datasets[0].data = [];
        grafico2.data.datasets[0].data = [];
        grafico2.data.datasets[1].data = [];

        document.getElementById('tempoIdeal').innerText = '__';
        document.getElementById('alertas').innerText = '__';
        document.getElementById('picos').innerText = '__';

        grafico1.update();
        grafico2.update();
        return;
      }
      //crio uma variavel para chamar os valores que ele está setando segundo o select q esta no meu valor
      const dados = dadosSensor[valor];

      //chamando o grafico e os dados para setar os dados da minha array
      //chamo os dados da linha para o meu grafico
      //uso o 0 por ser o primeiro dado a entrar no meu grafico1
      //data.datasets[0].data é apenas o caminho que tem dentro do grafico para setar os dados no grafico igual no grafico quando se seta na mão
      grafico1.data.datasets[0].data = dados.linha;
      //chamo os dados da barra para o meu grafico
      //uso 0 por ser o pr'imeiro dado a entrar no meu grafico 2
      grafico2.data.datasets[0].data = dados.barras;
      //chamo os dados da desvios para o meu grafico
      //uso 1 por ser o segundo dado no meu grafico 2 de barras
      grafico2.data.datasets[1].data = dados.desvios;

      //substituo os valores das minhas kpis reescrevendo com os dados do meu sensor 1 setado no array dadosEstufas->dados
      document.getElementById('tempoIdeal').innerText = dados.tempoIdeal;
      document.getElementById('alertas').innerText = dados.alertas;
      document.getElementById('picos').innerText = dados.picos;

      //atualizo na pagina
      grafico1.update();
      grafico2.update();
    });

  </script>
</body>

</html>